# 学习具有一般分布依赖性的高维 McKean-Vlasov 正倒向随机微分方程

代码：https://github.com/frankhan91/DeepMVBSDE

## 基本概念

- **平均场**：将复杂系统中大量的个体相互作用简化为单个个体与群体平均行为的交互。关键特点是使用群体效应代替个体交互，降低了复杂度。
- **平均场博弈**：研究大量相似理性个体在相互影响下的决策行为，每个个体的策略取决于群体的整体状态，群体整体状态由所有个体的策略共同形成，即个体行为影响群体，群体状态又反过来影响个体决策的均衡问题。
  - 个体最优控制问题：HJB 方程 + 群体分布演化 Fokker-Planck 方程
- **平均场控制**：存在中央控制者，优化全局目标
- **Cucker-Smale 模型**：描述自驱动粒子群体（如鸟群）自组织形成一致运动的数学模型
  - 个体通过局部交互调整自身速度，逐渐与邻居趋同；
  - 无需中央控制，仅依靠简单规则即可涌现群体同步行为；
- **虚拟博弈 (Fictitious Play)**: 用于求解博弈论中均衡策略的迭代学习算法，用于模拟玩家如何通过观察对手的历史行为选择自己的最优响应，最终收敛到纳什均衡。
- **连续统 (Continuum)**: 连续不断的数集；
- **Pontryagin 最大值原理**：作为现代控制理论的核心工具，将最优控制问题转化为一个哈密顿系统的极值问题，通过引入协态变量 (Costate)，将动态优化问题转化为一组微分方程（正向状态方程+倒向协态方程）的求解问题。提供了必要条件，在凸性问题中可保证全局最优。

## 摘要

**平均场 (Mean-Field Control)** 和**平均场博弈 (Mean-Field Game)** 的核心问题之一是求解相应的 McKean-Vlasov 正倒向随机微分方程 (MV-FBSDEs)。
大多数现有方法仅适用于一些特殊情形，其平均场相互作用仅依赖于期望或其他矩量，因此当平均场相互作用具有完全分布依赖性时不能适当地求解问题。

本文提出了一个新式深度学习方法，用于计算具有平均场相互作用一般形式的 MV-FBSDE。
具体来说，基于**虚拟博弈 (Fictitious Play)**，我们将原问题转化为重复求解具有显式系数函数的标准 FBSDEs。
这些系数函数用于近似具有完全分布依赖性的 MV-FBSDE 的模型系数，并通过利用前次迭代的 FBSDE 的解仿真的训练数据求解另外的监督学习问题来更新这些系数。
我们使用深度神经网络求解标准的 BSDEs 和近似系数函数以求解高维的 MV-FBSDEs。

对学习到的函数进行适当的假设，我们使用 [《A Class of Dimension-free Metrics for the Convergence of Empirical Measures》](https://arxiv.org/abs/2104.12036) 提出的一类积分概率度量，证明了所提方法的收敛性不受维度灾难的影响。
证明的定理展示了方法在高维情形下的优势。

我们在高维 MV-FBSDE 问题展示了数值性能，包括著名的 Cucker-Smale 模型的平均场博弈示例，其成本依赖于前向过程的全分布。

## 引言

**McKean-Vlasov 正倒向随机微分方程 (MV-FBSDEs)** 是**平均场博弈 (MFGs)** 和**平均场控制 (MFC)** 问题的自然表述形式。

- 由 Lasry-Lions [^33] [^34] [^35] 和 Huang-Malhame-Caines [^30] [^31] 首次提出， MFG 研究同质智能体**连续统**的策略决策问题，其中每个智能体都旨在最大化自身目标。
由于每个智能体都是无限小 (infinitesimal) 的，在优化其自身的成本泛函时，状态过程随机变量的概率分布被视为固定的。
因此，这只是一个标准的最优控制问题加上一个不动点论证（解的分布等于初始分布）。

- 从稍有不同的角度来看，MFC 分析 McKean-Vlasov 型随机微分方程（SDEs）的最优控制，这可以解释为大群体智能体之间合作博弈的极限状态。
这个目标为不动点增加了一个额外的优化层，即状态过程的分布随着目标优化而变化。

尽管存在差异，这两个问题都可以通过使用 **Pontryagin 最大值原理**分析 MV-FBSDEs 来解决 [^09] [^11]，并且这两个解都可以作为交互方式和目标函数为平均场类型的大群体个体的近似均衡策略。

关于它们差异和关系的更多解释，我们推荐读者参阅 [^11] 第6节。

---

本文中，我们致力于开发有效的深度学习方法并分析以下 MV-FBSDEs 的数值收敛性：

$$
\begin{cases}
\mathrm{d} X_t = \textcolor{cyan}{b(t, X_t, Y_t, Z_t, \mathcal{L}(X_t, Y_t, Z_t))} \text{d} t + \textcolor{orange}{\sigma(t, X_t, Y_t, Z_t, \mathcal{L}(X_t, Y_t, Z_t))} \text{d} W_t,  &X_0 = x_0,  \\
\mathrm{d} Y_t = -\textcolor{red}{h(t, X_t, Y_t, Z_t, \mathcal{L}(X_t, Y_t, Z_t))} \text{d} t + Z_t \text{d} W_t, &Y_T = g(X_T, \mathcal{L}(X_T)),
\end{cases}
$$

- 在有限时间区间 $[0,T]$上，
- $\mathcal{L}(\cdot)$ 表示过程的边缘概率分布，
- $(b, \sigma, h, g)$ 是具有兼容维数的可测函数，具体形式详见第 2 节。

特别地，我们将重点计算具有一般形式的平均场相互作用的高维 MV-FBSDEs，而现有方法大多仅处理平均场相互作用通过期望或其他矩量描述的特殊情况。

---

理论上，MV-FBSDEs 的存在性和唯一性结果最近已经发展起来 [^08] [^09] [^10]，主要通过紧致性论证和不动点定理解决。

特别地，当 $\sigma$ 不依赖于 $Z_t$ 和 $\mathcal{L}(Z_t)$时，在适当条件下 [^11] (定理 4.29，备注 4.30)，MV-FBSDEs 允许具有解耦场的解：

$$
    Y_t = u(t, X_t), \quad Z_t = v(t, X_t)
$$

- 其中 $v(t, x) = \partial_x u(t, x) \textcolor{orange}{\sigma(t, x, u(t, x), \textcolor{red}{(I_d, u(t, \cdot))(\mathcal{L}(X_t))})}$。

已经设计了几种数值算法来求解 MV-FBSDEs，包括:
- 递归局部 Picard 迭代方法 [^13];
- 解耦设置下的基于 cubature 的算法 [^15];
- 以及深度学习方法 [^12] [^21]。

大多数工作，无论是否有分析，都只展示了一种特殊类型平均场相互作用的数值例子，即 $(b, \sigma, h, g)$ 仅通过其期望依赖于$\mathcal{L}$。

在相关主题上，MFGs 和 MFC 问题也已通过偏微分方程和使用神经网络解决高维问题；例如参见 [^02] [^45] [^44] [^01]。

---

与我们的工作最密切相关的是 [^21]。

它使用深度学习解决 MV-FBSDEs，并且 $(b, \sigma, h, g)$ 相对于 $\mathcal{L}(X_t, Y_t, Z_t)$ 的依赖仅以 $(\mathbb{E}[\varphi_1(X_t)], \mathbb{E}[\varphi_2(Y_t)], \mathbb{E}[\varphi_3(Z_t)])$ 的形式出现，其中 $\varphi_i$ 是一些连续函数。
为此，本质上是在估计一些均衡数 $\int_y \varphi_i(y) \,\mu(\mathrm{d}y)$，其中 $\mu$ 是 MV-FBSDE 解的概率分布。
超出仅依赖于矩量的范围（本文的范围），目标是学习以非线性方式依赖于分布的均衡函数，例如形式为 $\int_y \varphi(t, x, y) \, \mu(\mathrm{d}y)$ 的 $(t,x)$ 函数。这在算法设计和表示这些量的方法方面都带来了更大的挑战。

我们提出了一种新颖的深度学习方法来求解高维 MV-FBSDEs，利用虚拟博弈的思想 [^06] [^07]和现有的机器学习BSDE求解器 [^16] [^26] [^27] [^32]，具有处理一般平均场依赖（不仅仅是矩量）的能力。

主要贡献包括：

1. 受 MV-FBSDEs 的不动点性质启发，我们使用虚拟博弈并求解
$$
\begin{dcases}
  \text{d} X_t^k = \textcolor{cyan}{b(t, \Theta_t^k, \mathcal{L}(\Theta_t^{k-1}))} \text{d} t + \textcolor{orange}{\sigma(t, \Theta_t^k, \mathcal{L}(\Theta_t^{k-1}))} \text{d} W_t,  &X_0 = x_0,  \\
  \text{d} Y_t^k = -\textcolor{red}{h(t, \Theta_t^{k}, \mathcal{L}(\Theta_t^{k-1}))} \text{d} t + Z_t^k \text{d} W_t, &Y_T = g(X_T^k, \mathcal{L}(X_T^{k-1})),
\end{dcases}
$$

在解耦场形式的解中（即寻找一些确定性函数 $u^k, v^k$，它们被视为对 MV-FBSDE 中定义的 $u, v$ 的近似，使得 $Y_t^k = u^k(t, X_t^k), Z_t^k = v^k(t, X_t^k)$），通过现有的 BSDE 求解器迭代求解。
为了加速BSDE求解器对 $(X^k, Y^k)$ 的模拟，我们提出使用神经网络通过监督学习学习映射 $(t, X_t, Y_t, Z_t) \mapsto (b, \sigma, h, g)$，当它们完全依赖于任何分布时。在数值上，函数值（也称为"标签"）通过用上一次迭代解的相应经验分布替换 $\mathcal{L}(\cdot)$ 来近似，并且学习的映射在每次迭代后更新。

2. 我们证明了所提算法的收敛性。
使用 [25] 中提出的积分概率度量，学习过程与解之间的差异可以足够小且不受维度灾难的影响，前提是学习函数具有足够的平滑性、虚拟游戏的足够迭代次数以及足够小的时间步长。

3. 我们引入了一个 Cucker-Smale 模型的平均场博弈，其中成本依赖于正向过程的完整分布。我们提供了数值基准，并希望这将促进对MV-FBSDEs数值算法的进一步研究。

---

本文的其余部分组织如下。
- 第 2 节回顾了虚拟博弈的思想和两种现有的基于深度学习（DL）的BSDE求解器：Deep BSDE 和 DBDP，并描述了我们提出的算法。
- 第 3 节提供了所提算法的收敛性分析。
- 第 4 节展示了两个数值例子。
  - 第一个是十维的，具有解析解作为基准。值得一提的是，第一个例子不是文献中广泛使用的与线性二次问题相关的 MV-FBSDEs。
  - 在第二个例子中，我们研究了 Cucker-Smale 模型下的平均场群集问题。平均场相互作用涉及状态过程的整个分布。
- 第 5 节总结本文工作。
